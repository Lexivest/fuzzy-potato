<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
(async () => {
  const card = document.getElementById('card');

  // CONFIG – replace with your project values
  const SUPABASE_URL = 'https://zhflwgfzshtqcfwsvnnv.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpoZmx3Z2Z6c2h0cWNmd3N2bm52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2MzIyMzIsImV4cCI6MjA2NTIwODIzMn0.bjDDebogf3DzsQlIXy_Dc-g2H0oi2dRf6dCU40zqGMI';

  // ── 1. Parse query & hash
  const query = new URLSearchParams(location.search.slice(1));
  const hash  = new URLSearchParams(location.hash.slice(1));

  // ── 2. Handle error in query (otp_expired, etc.)
  if (query.has('error')) {
    card.innerHTML = `
      <h2>Link invalid or expired</h2>
      <p>${query.get('error_description') ?? 'Please request a new email.'}</p>
    `;
    return;
  }

  // ── 3. Init Supabase client via window.supabase
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  try {
    // A) Modern ?code=... flow
    if (query.has('code')) {
      const { error } = await supabase.auth.exchangeCodeForSession(query.get('code'));
      if (error) throw error;

      card.innerHTML = `
        <h2>Email verified!</h2>
        <p>You can now return to the Kadazon app and log in.</p>
      `;
      return;
    }

    // B) Legacy hash flow #access_token=...
    if (hash.has('access_token') && hash.has('refresh_token')) {
      const { error } = await supabase.auth.setSession({
        access_token:  hash.get('access_token'),
        refresh_token: hash.get('refresh_token'),
      });
      if (error) throw error;

      const type = hash.get('type');
      card.innerHTML = `
        <h2>${type === 'recovery' ? 'Password reset successful!' : 'Email verified!'}</h2>
        <p>You can now return to the Kadazon app and log in.</p>
      `;
      return;
    }

    // C) Fallback
    throw new Error('Auth session missing');
  } catch (err) {
    card.innerHTML = `
      <h2>Something went wrong</h2>
      <p>${err.message}</p>
      <p>Please try again or request a fresh email from the app.</p>
    `;
  }
})();
</script>
